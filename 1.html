<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì—°ë„ë³„ íŒë§¤ ì‹¤ì  ëŒ€ì‹œë³´ë“œ</title>
<!-- Chart.js v4.4.3: ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
Â  body{font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",Roboto,Helvetica,Arial,sans-serif;background:#f4f7fb;margin:0;padding:0}
Â  header{background:#1652f0;color:#fff;padding:14px 20px;font-weight:700}
Â  .container{max-width:1200px;margin:28px auto;padding:0 18px}
Â  .loader{display:flex;gap:12px;align-items:center;color:#334155}
Â  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:14px 0}
Â  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
Â  /* <<<--- CSS ìˆ˜ì • ë¶€ë¶„: ì°¨íŠ¸ ë˜í¼ì— ìµœëŒ€ ë†’ì´ ì„¤ì • --->>> */
Â  #chartWrap{
Â  Â  background:#fff;
Â  Â  padding:18px;
Â  Â  border-radius:10px;
Â  Â  box-shadow:0 6px 18px rgba(16,24,40,0.06);
Â  Â  margin-top:16px;
Â  Â  /* ìµœëŒ€ ë†’ì´ë¥¼ 400pxë¡œ ì œí•œí•˜ì—¬ í™”ë©´ í™•ëŒ€ ì‹œ ë¬´í•œì • ì»¤ì§€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. */
Â  Â  max-height: 400px; 
Â  Â  position: relative; /* ìº”ë²„ìŠ¤ height: 100%ë¥¼ ìœ„í•´ ì¶”ê°€ */
Â  }
Â  #salesChart {
Â  Â  height: 100%; /* ë¶€ëª¨ì˜ max-heightë¥¼ ë”°ë¥´ë„ë¡ ì„¤ì • */
Â  }
Â  /* <<<--- CSS ìˆ˜ì • ë¶€ë¶„ ë --->>> */
Â  .controls{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-bottom:10px; flex-wrap: wrap;}
Â  select,button{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff; cursor: pointer;}
Â  select:hover, button:hover { border-color: #1652f0; }
Â  #refreshBtn { background-color: #1652f0; color: white; border-color: #1652f0; }
Â  .status{color:#6b7280;font-size:14px}
Â  .small{font-size:13px;color:#6b7280}
Â  table{width:100%;border-collapse:collapse;font-size:14px;}
Â  th,td{padding:10px;border-bottom:1px solid #eef2ff;text-align:right}
Â  th{background-color: #f8fafc; font-weight: 600; color: #334155; border-top: 1px solid #eef2ff;}
Â  th:first-child,td:first-child{text-align:left}
Â  .legendDot{display:inline-block;width:12px;height:12px;border-radius:2px;margin-right:8px}
</style>
</head>
<body>
<header>ğŸ“Š ì—°ë„ë³„ íŒë§¤ ì‹¤ì  ìë™ ëŒ€ì‹œë³´ë“œ</header>
<div class="container">
Â  <div id="top" class="card">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  <div>
Â  Â  Â  Â  <div style="font-weight:700;font-size:18px">í¬í„°Â·ë´‰ê³  ëª¨ë¸ ì›”ë³„ íŒë§¤ëŸ‰ (ì—°ë„ë³„)</div>
Â  Â  Â  Â  <div class="small">êµ¬ê¸€ ì‹œíŠ¸ì— ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ë©´ ëŒ€ì‹œë³´ë“œê°€ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
Â  Â  Â  </div>
Â  Â  Â  <div style="text-align:right">
Â  Â  Â  Â  <div id="status" class="status">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
Â  Â  Â  Â  <div class="small">ìë™ ìƒˆë¡œê³ ì¹¨: <span id="autoInterval">60</span>s</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="kpis" id="kpiSection">
Â  Â  <!-- KPI ì¹´ë“œ ë™ì  ì‚½ì… -->
Â  </div>

Â  <div class="card">
Â  Â  <div class="controls">
Â  Â  Â  <label class="small">ì—°ë„ ì„ íƒ</label>
Â  Â  Â  <select id="yearFilter"><option value="All">ì „ì²´ ì—°ë„</option></select>

Â  Â  Â  <label class="small">ì—°ë£Œ</label>
Â  Â  Â  <select id="fuelFilter"><option value="All">ì „ì²´</option></select>

Â  Â  Â  <button id="refreshBtn">ì§€ê¸ˆ ìƒˆë¡œê³ ì¹¨</button>
Â  Â  Â  <button id="toggleAuto">ìë™ ON</button>
Â  Â  </div>

Â  Â  <div id="chartWrap">
Â  Â  Â  <!-- height="150" ì†ì„±ì„ ì œê±°í•˜ê³  CSSì—ì„œ ë†’ì´ë¥¼ ì œì–´í•˜ë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. -->
Â  Â  Â  <canvas id="salesChart"></canvas>
Â  Â  </div>
Â  </div>

Â  <div class="card" style="margin-top:16px">
Â  Â  <div style="font-weight:700;margin-bottom:8px">ë°ì´í„° í…Œì´ë¸” (ì—°ë„-ì›” Â· ëª¨ë¸ Â· ì—°ë£Œ Â· íŒë§¤ëŸ‰)</div>
Â  Â  <div style="overflow:auto;max-height:360px">
Â  Â  Â  <table id="dataTable">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr><th>ì—°ë„-ì›”</th><th>ëª¨ë¸</th><th>ì—°ë£Œ</th><th>íŒë§¤ëŸ‰</th></tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div style="height: 10px;"></div>
Â  </div>
</div>

<script>
(() => {
Â  // ì„¤ì •
Â  // **ì£¼ì˜: ì´ URLì€ ê³ ê°ë‹˜ê»˜ì„œ ì œê³µí•˜ì‹  ì˜ˆì‹œ URLì…ë‹ˆë‹¤.**
Â  const SHEET_URL = "https://docs.google.com/spreadsheets/d/1K3cudjOZ_kTujuGe_jRaMbJUkWj7a9kiym_IVPLX94I/gviz/tq?tqx=out:json";
Â  const AUTO_REFRESH_SECONDS = 60; // ìë™ ìƒˆë¡œê³ ì¹¨ ì´ˆ
Â  let autoTimer = null;
Â  let autoOn = true;
Â  let rawRows = []; // ì›ì‹œ ë°ì´í„°
Â  let SALES = {};Â  Â // { year: { month: { "ëª¨ë¸": { "ì—°ë£Œ": value } } } }
Â  let chartInstance = null;

Â  // DOM ìš”ì†Œ ìºì‹±
Â  const $status = document.getElementById('status');
Â  const $yearFilter = document.getElementById('yearFilter');
Â  const $fuelFilter = document.getElementById('fuelFilter');
Â  const $refreshBtn = document.getElementById('refreshBtn');
Â  const $toggleAuto = document.getElementById('toggleAuto');
Â  const $kpiSection = document.getElementById('kpiSection');
Â  const $dataTableBody = document.querySelector('#dataTable tbody');
Â  const $autoIntervalLabel = document.getElementById('autoInterval');

Â  $autoIntervalLabel.textContent = AUTO_REFRESH_SECONDS;

Â  // ì•ˆì „í•œ JSON ì¶”ì¶œ í•¨ìˆ˜ (gviz ì‘ë‹µì—ì„œ ë‚´ë¶€ JSON ë½‘ê¸°)
Â  function extractJsonFromGviz(text) {
Â  Â  // êµ¬ê¸€ gviz í˜•ì‹: google.visualization.Query.setResponse({...});
Â  Â  const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
Â  Â  if (!match) throw new Error('gviz í¬ë§· ë¯¸ë°œê²¬');
Â  Â  return JSON.parse(match[1]);
Â  }

Â  // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
Â  async function fetchSheet() {
Â  Â  $status.textContent = 'êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...';
Â  Â  // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ì§€
Â  Â  stopAuto();
Â  Â  try {
Â  Â  Â  // no-storeë¥¼ ì‚¬ìš©í•˜ì—¬ ìºì‹œ ë°©ì§€ ë° ìµœì‹  ë°ì´í„° ë¡œë“œ
Â  Â  Â  const res = await fetch(SHEET_URL, {cache: "no-store"});
Â  Â  Â  const txt = await res.text();

Â  Â  Â  // ì¶”ì¶œ ë° íŒŒì‹±
Â  Â  Â  let json;
Â  Â  Â  try {
Â  Â  Â  Â  json = extractJsonFromGviz(txt);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('GViz íŒŒì‹± ì‹¤íŒ¨ - ì‘ë‹µ ì•ë¶€ë¶„(200ì):', txt.slice(0,200));
Â  Â  Â  Â  throw new Error('ë°ì´í„° ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨');
Â  Â  Â  }

Â  Â  Â  const rows = json.table.rows || [];
Â  Â  Â  const parsedHeaders = json.table.parsedNumHeaders || 0;

Â  Â  Â  rawRows = rows.slice(parsedHeaders); // í—¤ë” ìŠ¤í‚µ
Â  Â  Â  $status.textContent = `ì›ì‹œ ë ˆì½”ë“œ ${rawRows.length}ê±´ ë¡œë“œ ì™„ë£Œ`;

Â  Â  Â  buildSalesStructure(rawRows);
Â  Â  Â  populateFilters();
Â  Â  Â  renderAll();
Â  Â  Â  
Â  Â  } catch (err) {
Â  Â  Â  console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', err);
Â  Â  Â  $status.textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ - ì½˜ì†” í™•ì¸';
Â  Â  } finally {
Â  Â  Â  // ì„±ê³µ/ì‹¤íŒ¨ì™€ ìƒê´€ì—†ì´ ìë™ ìƒˆë¡œê³ ì¹¨ ì¬ì‹œì‘ (autoOn ìƒíƒœì¸ ê²½ìš°)
Â  Â  Â  if (autoOn) startAuto();
Â  Â  }
Â  }

Â  // SALES êµ¬ì¡° ìƒì„±: { year: { month: { "ëª¨ë¸": { "ì—°ë£Œ": value } } } }
Â  function buildSalesStructure(rows) {
Â  Â  SALES = {};
Â  Â  rows.forEach(r => {
Â  Â  Â  // r.c ë°°ì—´: [ì—°ë„, ëª¨ë¸, ì—°ë£Œêµ¬ë¶„, ì›”, íŒë§¤ëŸ‰] (ì‹œíŠ¸ ìˆœì„œì— ë”°ë¼ ë‹¤ë¦„)
Â  Â  Â  // ì‹œíŠ¸ ì»¬ëŸ¼ ìˆœì„œ (A, B, C, D, E)
Â  Â  Â  const c = r.c || [];
Â  Â  Â  const year = c[0]?.v;Â  Â  // Aì—´
Â  Â  Â  const model = c[1]?.v;Â  // Bì—´
Â  Â  Â  const fuel = c[2]?.v;Â  Â  // Cì—´
Â  Â  Â  const month = c[3]?.v;Â  // Dì—´ (ìˆ«ì)
Â  Â  Â  const sales = (typeof c[4]?.v === 'number') ? c[4].v : (c[4]?.v ? Number(c[4].v) : null); // Eì—´ (ìˆ«ì)

Â  Â  Â  // ìœ íš¨ì¹˜ë§Œ ì²˜ë¦¬ (ì—°ë„, ì›”, ëª¨ë¸, ì—°ë£Œê°€ ëª¨ë‘ ì¡´ì¬í•´ì•¼ ìœ ì˜ë¯¸)
Â  Â  Â  if (year == null || month == null || model == null || fuel == null) return;

Â  Â  Â  if (!SALES[year]) SALES[year] = {};
Â  Â  Â  if (!SALES[year][month]) SALES[year][month] = {};
Â  Â  Â  if (!SALES[year][month][model]) SALES[year][month][model] = {};
Â  Â  Â  SALES[year][month][model][fuel] = (sales == null) ? null : sales; // salesëŠ” ì´ë¯¸ ìˆ«ìë¡œ ë³€í™˜ë¨
Â  Â  });
Â  }

Â  // í•„í„° ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
Â  function populateFilters() {
Â  Â  // ì—°ë„ í•„í„°
Â  Â  const years = Object.keys(SALES).sort().reverse(); // ìµœì‹  ì—°ë„ë¶€í„° ë³´ì´ë„ë¡ ì—­ìˆœ ì •ë ¬
Â  Â  $yearFilter.innerHTML = '<option value="All">ì „ì²´ ì—°ë„</option>';
Â  Â  years.forEach(y => {
Â  Â  Â  const o = document.createElement('option'); o.value = y; o.textContent = `${y}ë…„`; $yearFilter.appendChild(o);
Â  Â  });

Â  Â  // ì—°ë£Œ í•„í„°
Â  Â  const fuels = new Set();
Â  Â  rawRows.forEach(r => {
Â  Â  Â  const f = r.c?.[2]?.v; // ì—°ë£Œ(Cì—´)
Â  Â  Â  if (f != null) fuels.add(f);
Â  Â  });
Â  Â  $fuelFilter.innerHTML = '<option value="All">ì „ì²´</option>';
Â  Â  Array.from(fuels).sort().forEach(f => {
Â  Â  Â  const o = document.createElement('option'); o.value = f; o.textContent = f; $fuelFilter.appendChild(o);
Â  Â  });
Â  }

Â  // ì°¨íŠ¸ìš© ë°ì´í„° ì§‘ê³„ (ëª¨ë¸+ì—°ë£Œ ì¡°í•© ë³„ë¡œ ë¼ì¸ ìƒì„±)
Â  function buildChartDatasets(selectedYear, selectedFuel) {
Â  Â  // 1. ë¼ë²¨(ì—°ë„-ì›”) ê³ ì •: ëª¨ë“  ì—°ë„ì›” ì¡°í•©ì„ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ìˆ˜ì§‘
Â  Â  const labelSet = new Set();
Â  Â  Object.keys(SALES).sort().forEach(y => {
Â  Â  Â  Object.keys(SALES[y]).sort((a,b)=>Number(a)-Number(b)).forEach(m => {
Â  Â  Â  Â  // í•„í„°ë§ëœ ì—°ë„ë§Œ ì°¨íŠ¸ xì¶•ì— í‘œì‹œ
Â  Â  Â  Â  if (selectedYear === 'All' || String(y) === String(selectedYear)) {
Â  Â  Â  Â  Â  labelSet.add(`${y}-${String(m).padStart(2,'0')}`);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });
Â  Â  const labels = Array.from(labelSet).sort();


Â  Â  // 2. ì¡°í•© í‚¤ ë° ë°ì´í„° í¬ì¸íŠ¸ ìˆ˜ì§‘
Â  Â  const combos = {}; // "ëª¨ë¸|ì—°ë£Œ" => [íŒë§¤ëŸ‰1, íŒë§¤ëŸ‰2, ...]
Â  Â  
Â  Â  Object.keys(SALES).sort().forEach(y => {
Â  Â  Â  Object.keys(SALES[y]).sort((a,b)=>Number(a)-Number(b)).forEach(m => {
Â  Â  Â  Â  const lm = `${y}-${String(m).padStart(2,'0')}`;

Â  Â  Â  Â  // í˜„ì¬ ì—°ì›”ì´ ì„ íƒëœ ë¼ë²¨ì— í¬í•¨ë˜ì–´ì•¼ í•¨
Â  Â  Â  Â  if (!labels.includes(lm)) return;
Â  Â  Â  Â  const idx = labels.indexOf(lm); // ë¼ë²¨ì—ì„œ í•´ë‹¹ ì›”ì˜ ì¸ë±ìŠ¤

Â  Â  Â  Â  Object.keys(SALES[y][m]).forEach(model => {
Â  Â  Â  Â  Â  Object.keys(SALES[y][m][model]).forEach(fuel => {
Â  Â  Â  Â  Â  Â  // ì—°ë£Œ í•„í„° ì ìš©
Â  Â  Â  Â  Â  Â  if (selectedFuel !== 'All' && fuel !== selectedFuel) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const key = `${model}|${fuel}`;
Â  Â  Â  Â  Â  Â  if (!combos[key]) combos[key] = Array(labels.length).fill(null);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const salesValue = SALES[y][m][model][fuel];
Â  Â  Â  Â  Â  Â  combos[key][idx] = salesValue; 
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });

Â  Â  // 3. datasets ìƒì„± (ìƒ‰ì€ HSLë¡œ ìë™ ë°°ì •)
Â  Â  const keys = Object.keys(combos).sort();
Â  Â  const datasets = keys.map((k,i) => {
Â  Â  Â  const [model,fuel] = k.split('|');
Â  Â  Â  // HSL ìƒ‰ìƒìœ¼ë¡œ ë¼ì¸ë§ˆë‹¤ ë‹¤ë¥¸ ìƒ‰ì„ ë¶€ì—¬
Â  Â  Â  const hue = (i * 73) % 360; 
Â  Â  Â  const color = `hsl(${hue} 81% 45%)`;
Â  Â  Â  
Â  Â  Â  return {
Â  Â  Â  Â  label: `${model} (${fuel})`,
Â  Â  Â  Â  data: combos[k],
Â  Â  Â  Â  borderColor: color,
Â  Â  Â  Â  backgroundColor: `hsl(${hue} 81% 45% / 0.12)`, // ì±„ìš°ê¸° ìƒ‰ìƒ
Â  Â  Â  Â  spanGaps: true, // ë°ì´í„°ê°€ ì—†ì–´ë„ ë¼ì¸ì„ ì´ì–´ì„œ ê·¸ë¦¼
Â  Â  Â  Â  tension: 0.25, // ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
Â  Â  Â  Â  pointRadius: 3,
Â  Â  Â  Â  borderWidth: 2
Â  Â  Â  };
Â  Â  });

Â  Â  return { labels, datasets };
Â  }

Â  // KPI ë Œë”ë§: ìƒìœ„ 3ê°œ ëª¨ë¸(ì„ íƒ í•„í„° ê¸°ì¤€) í‘œì‹œ
Â  function renderKPIs(selectedYear, selectedFuel) {
Â  Â  // ì§‘ê³„: "ëª¨ë¸ (ì—°ë£Œ)" -> ì´ íŒë§¤ëŸ‰
Â  Â  const totals = {}; 
Â  Â  Object.keys(SALES).forEach(y => {
Â  Â  Â  if (selectedYear !== 'All' && String(y) !== String(selectedYear)) return;
Â  Â  Â  Object.keys(SALES[y]).forEach(m => {
Â  Â  Â  Â  Object.keys(SALES[y][m]).forEach(model => {
Â  Â  Â  Â  Â  Object.keys(SALES[y][m][model]).forEach(fuel => {
Â  Â  Â  Â  Â  Â  if (selectedFuel !== 'All' && fuel !== selectedFuel) return;
Â  Â  Â  Â  Â  Â  const v = SALES[y][m][model][fuel];
Â  Â  Â  Â  Â  Â  if (v == null) return;
Â  Â  Â  Â  Â  Â  const key = `${model} (${fuel})`;
Â  Â  Â  Â  Â  Â  totals[key] = (totals[key] || 0) + v;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });

Â  Â  // ìƒìœ„ 3ê°œ í•­ëª© ì¶”ì¶œ
Â  Â  const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,3);
Â  Â  $kpiSection.innerHTML = '';
Â  Â  
Â  Â  // ì „ì²´ í•©ì‚° KPI ì¶”ê°€ (Top 3 ì•ì—)
Â  Â  const overallTotal = Object.values(totals).reduce((sum, current) => sum + current, 0);
Â  Â  if (overallTotal > 0 || entries.length > 0) {
Â  Â  Â  const totalCard = document.createElement('div');
Â  Â  Â  totalCard.className = 'card';
Â  Â  Â  totalCard.innerHTML = `<div style="font-size:13px;color:#1652f0; font-weight: 700;">ì´ íŒë§¤ëŸ‰ (${selectedYear === 'All' ? 'ì „ì²´ ê¸°ê°„' : selectedYear+'ë…„'})</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div style="font-weight:700;font-size:24px;margin-top:4px">${overallTotal.toLocaleString()}ëŒ€</div>`;
Â  Â  Â  $kpiSection.appendChild(totalCard);
Â  Â  }

Â  Â  if (entries.length === 0) {
Â  Â  Â  // ì „ì²´ í•©ì‚° KPIëŠ” ìœ„ì—ì„œ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ, Top 3ê°€ ì—†ì„ ê²½ìš°ë§Œ ì¶”ê°€ ë©”ì‹œì§€ í‘œì‹œ
Â  Â  Â  if (overallTotal === 0) {
Â  Â  Â  Â  $kpiSection.innerHTML = '<div class="card" style="grid-column: 1 / -1;">í‘œì‹œí•  KPI ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>';
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }

Â  Â  // Top 3 KPI ì¹´ë“œ ì¶”ê°€
Â  Â  entries.forEach(([label,val])=>{
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'card';
Â  Â  Â  div.innerHTML = `<div style="font-size:13px;color:#6b7280">${label} (Top ëª¨ë¸)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div style="font-weight:700;font-size:20px;margin-top:6px">${val.toLocaleString()}ëŒ€</div>`;
Â  Â  Â  $kpiSection.appendChild(div);
Â  Â  });
Â  }

Â  // í…Œì´ë¸” ë Œë”
Â  function renderTable(selectedYear, selectedFuel) {
Â  Â  $dataTableBody.innerHTML = '';
Â  Â  const rows = [];
Â  Â  // ë°ì´í„° ì¶”ì¶œ ë° í•„í„°ë§
Â  Â  Object.keys(SALES).forEach(y=>{
Â  Â  Â  if (selectedYear !== 'All' && String(y)!==String(selectedYear)) return;
Â  Â  Â  Object.keys(SALES[y]).forEach(m=>{
Â  Â  Â  Â  Object.keys(SALES[y][m]).forEach(model=>{
Â  Â  Â  Â  Â  Object.keys(SALES[y][m][model]).forEach(fuel=>{
Â  Â  Â  Â  Â  Â  if (selectedFuel !== 'All' && fuel !== selectedFuel) return;
Â  Â  Â  Â  Â  Â  const sales = SALES[y][m][model][fuel];
Â  Â  Â  Â  Â  Â  rows.push({ ym: `${y}-${String(m).padStart(2,'0')}`, model, fuel, sales });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });

Â  Â  // ì •ë ¬: ì—°ë„-ì›” asc, ëª¨ë¸ asc
Â  Â  rows.sort((a,b) => a.ym.localeCompare(b.ym) || a.model.localeCompare(b.model));

Â  Â  // í…Œì´ë¸” í–‰ ìƒì„±
Â  Â  rows.forEach(r=>{
Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  tr.innerHTML = `<td>${r.ym}</td><td style="text-align:left">${r.model}</td><td>${r.fuel}</td><td>${r.sales == null ? '-' : r.sales.toLocaleString()}</td>`;
Â  Â  Â  $dataTableBody.appendChild(tr);
Â  Â  });
Â  }

Â  // ì „ì²´ ë Œë”
Â  function renderAll() {
Â  Â  const selectedYear = $yearFilter.value;
Â  Â  const selectedFuel = $fuelFilter.value;

Â  Â  // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
Â  Â  const { labels, datasets } = buildChartDatasets(selectedYear, selectedFuel);

Â  Â  // ì°¨íŠ¸ ë Œë”/ì—…ë°ì´íŠ¸
Â  Â  const ctx = document.getElementById('salesChart').getContext('2d');
Â  Â  if (chartInstance) chartInstance.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
Â  Â  chartInstance = new Chart(ctx, {
Â  Â  Â  type: 'line',
Â  Â  Â  data: { labels, datasets },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  // maintainAspectRatio: falseê°€ ê¸°ë³¸ê°’ì´ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
Â  Â  Â  Â  maintainAspectRatio: false, 
Â  Â  Â  Â  interaction: {
Â  Â  Â  Â  Â  mode: 'index',
Â  Â  Â  Â  Â  intersect: false,
Â  Â  Â  Â  },
Â  Â  Â  Â  plugins: { 
Â  Â  Â  Â  Â  legend: { position: 'top' },
Â  Â  Â  Â  Â  tooltip: { 
Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  label: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  let label = context.dataset.label || '';
Â  Â  Â  Â  Â  Â  Â  Â  if (label) { label += ': '; }
Â  Â  Â  Â  Â  Â  Â  Â  if (context.parsed.y !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  label += context.parsed.y.toLocaleString() + ' ëŒ€';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return label;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  y: { 
Â  Â  Â  Â  Â  Â  title: { display:true, text: 'íŒë§¤ëŸ‰ (ëŒ€)' }, 
Â  Â  Â  Â  Â  Â  beginAtZero:true,
Â  Â  Â  Â  Â  Â  ticks: { callback: function(value) { return value.toLocaleString(); } } // Yì¶• ë ˆì´ë¸” ì‰¼í‘œ ì¶”ê°€
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  x: { title: { display:true, text: 'ì—°ë„-ì›”' } }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  // KPI, Table ë Œë”
Â  Â  renderKPIs(selectedYear, selectedFuel);
Â  Â  renderTable(selectedYear, selectedFuel);

Â  Â  $status.textContent = `ìµœì‹  ë°ì´í„° ë¡œë“œ ì™„ë£Œ | ì°¨íŠ¸: ${datasets.length} ë¼ì¸ Â· ${labels.length} ê°œì›”`;

Â  }

Â  // event ë°”ì¸ë”©
Â  $refreshBtn.addEventListener('click', () => fetchSheet());
Â  $yearFilter.addEventListener('change', renderAll);
Â  $fuelFilter.addEventListener('change', renderAll);
Â  $toggleAuto.addEventListener('click', () => {
Â  Â  autoOn = !autoOn;
Â  Â  $toggleAuto.textContent = autoOn ? 'ìë™ ON' : 'ìë™ OFF';
Â  Â  if (autoOn) startAuto(); else stopAuto();
Â  Â  // ìƒíƒœ ì €ì¥ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
Â  });

Â  // ìë™ ìƒˆë¡œê³ ì¹¨
Â  function startAuto() {
Â  Â  stopAuto();
Â  Â  autoTimer = setInterval(() => {
Â  Â  Â  console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
Â  Â  Â  fetchSheet();
Â  Â  }, AUTO_REFRESH_SECONDS * 1000);
Â  }
Â  function stopAuto() { 
Â  Â  if (autoTimer) { 
Â  Â  Â  clearInterval(autoTimer); 
Â  Â  Â  autoTimer = null; 
Â  Â  Â  console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì •ì§€.');
Â  Â  } 
Â  }

Â  // ì´ˆê¸° ì‹¤í–‰
Â  // í˜ì´ì§€ ë¡œë“œ í›„ ì¦‰ì‹œ ë°ì´í„° ë¡œë“œë¥¼ ì‹œì‘í•˜ê³ , ì„±ê³µ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ì„ ì‹œì‘í•©ë‹ˆë‹¤.
Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  // ì´ˆê¸° ìƒíƒœ ì„¤ì •
Â  Â  $toggleAuto.textContent = autoOn ? 'ìë™ ON' : 'ìë™ OFF';
Â  Â  fetchSheet();
Â  Â  // ë¸Œë¼ìš°ì € í¬ê¸° ë³€ê²½ ì‹œ ì°¨íŠ¸ ê°±ì‹  (ì„ íƒ ì‚¬í•­ì´ë‚˜ ë°˜ì‘ì„±ì„ ìœ„í•´ ì¶”ê°€)
Â  Â  window.addEventListener('resize', () => {
        if (chartInstance) {
            chartInstance.resize();
        }
    });
Â  });
Â  
})();
</script>
</body>
</html>
